<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">

<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Web server API</title><link rel="stylesheet" type="text/css" href="../../styles/main.css"><script language=JavaScript src="../../javascript/main.js"></script><script language=JavaScript src="../../javascript/prettify.js"></script><script language=JavaScript src="../../javascript/searchdata.js"></script></head><body class="ContentPage" onLoad="NDOnLoad();prettyPrint();"><script language=JavaScript><!--
if (browserType) {document.write("<div class=" + browserType + ">");if (browserVer) {document.write("<div class=" + browserVer + ">"); }}// --></script>

<!--  Generated by Natural Docs, version 1.52 -->
<!--  http://www.naturaldocs.org  -->

<!-- saved from url=(0026)http://www.naturaldocs.org -->




<div id=Content><div class="CSection"><div class=CTopic id=MainTopic><h1 class=CTitle><a name="Web_server_API"></a>Web server API</h1><div class=CBody><p>Both components of the <a href="thc_Web-tcl.html#Web_interface" class=LSection >Web interface</a>, the web server as well as the web application, can be extended if necessary.&nbsp; This page provides developer information about the web server.</p><!--START_ND_SUMMARY--><div class=Summary><div class=STitle>Summary</div><div class=SBorder><table border=0 cellspacing=0 cellpadding=0 class=STable><tr class="SMain"><td class=SEntry><a href="#Web_server_API" >Web server API</a></td><td class=SDescription>Both components of the <a href="thc_Web-tcl.html#Web_interface" class=LSection >Web interface</a>, the web server as well as the web application, can be extended if necessary. </td></tr><tr class="SGroup SIndent1"><td class=SEntry><a href="#HTTP_web_server_internals" >HTTP web server internals</a></td><td class=SDescription>The web server provided by the module <a href="thc_Web-tcl.html#Web_interface" class=LSection >Web interface</a> responds to <b>get</b> requests. </td></tr><tr class="SGroup SIndent1"><td class=SEntry><a href="#Web_server_commands" >Web server commands</a></td><td class=SDescription>This section provides the list of the standard web server commands.</td></tr><tr class="SFunction SIndent2 SMarked"><td class=SEntry><a href="#thc_Web.API.GetDeviceInfo" >thc_Web::<wbr>API::<wbr>GetDeviceInfo</a></td><td class=SDescription>Returns device information. </td></tr><tr class="SFunction SIndent2"><td class=SEntry><a href="#thc_Web.API.GetDeviceStatesAfterEvent" >thc_Web::<wbr>API::<wbr>GetDeviceStatesAfterEvent</a></td><td class=SDescription>Waits on event and returns device states. </td></tr><tr class="SFunction SIndent2 SMarked"><td class=SEntry><a href="#thc_Web.API.GetDeviceStates" >thc_Web::<wbr>API::<wbr>GetDeviceStates</a></td><td class=SDescription>Returns device states. </td></tr><tr class="SFunction SIndent2"><td class=SEntry><a href="#thc_Web.API.SetDeviceState" >thc_Web::<wbr>API::<wbr>SetDeviceState</a></td><td class=SDescription>Set device states. </td></tr><tr class="SFunction SIndent2 SMarked"><td class=SEntry><a href="#thc_Web.API.GetDeviceData" >thc_Web::<wbr>API::<wbr>GetDeviceData</a></td><td class=SDescription>Get device data. </td></tr><tr class="SGroup SIndent1"><td class=SEntry><a href="#Web_server_command_set_extension" >Web server command set extension</a></td><td class=SDescription>The initial web server command set can be extended by defining additional commands inside the namespace <b>thc_Web::API</b>. </td></tr></table></div></div><!--END_ND_SUMMARY--></div></div></div>

<div class="CGroup"><div class=CTopic><h3 class=CTitle><a name="HTTP_web_server_internals"></a>HTTP web server internals</h3><div class=CBody><p>The web server provided by the module <a href="thc_Web-tcl.html#Web_interface" class=LSection >Web interface</a> responds to <b>get</b> requests.&nbsp; It return either files or results from the commands provided by the <u>thc Web::API</u> namespace.</p><ul><li>File requests: The URL has to point to an existing file inside the web home directory &lsquo;modules/thc_Web/www_simple/&rsquo;.&nbsp; The master HTML file <b>index.html</b> will be returned if the URL is an empty string.&nbsp; If &lsquo;gzip&rsquo; encoding is accepted, and an equivalent compressed file with the ending &lsquo;.gz&rsquo; is available, this compressed file will be returned.</li><li>Command requests: If an URL starts with /api/ the tail string will be considered as command that will be executed and whose result will be returned.&nbsp; Command and arguments have to be separated by spaces (Tcl syntax).&nbsp; The web server support all commands that are part of the namespace <u>thc Web::API</u>.&nbsp; An initial commands set is provided by this sub module (see <a href="#Web_server_commands" class=LGroup id=link1 onMouseOver="ShowTip(event, 'tt1', 'link1')" onMouseOut="HideTip('tt1')">Web server commands</a>), but it can be extended if necessary (see <a href="#Web_server_command_set_extension" class=LGroup id=link2 onMouseOver="ShowTip(event, 'tt2', 'link2')" onMouseOut="HideTip('tt2')">Web server command set extension</a>).</li></ul><p>The following lines provides some command request examples.</p><h4 class=CHeading>Classic URL</h4><blockquote><pre>192.168.1.123/api/GetDeviceStates MyLight

localhost/api/SetDeviceState MyLight 0

192.168.1.123/api/GetDeviceInfo</pre></blockquote><h4 class=CHeading>Javascript/jQuery</h4><blockquote><pre>$.get(&quot;/api/SetDeviceState &quot;+DeviceId+&quot; 0&quot;);

$.getJSON('/api/GetDeviceInfo', function(DevicesInfo) {
   BuildGui(DevicesInfo);
});

setInterval(function() {
   $.ajax({
      url: &quot;/api/GetDeviceStates&quot;,
      success: function(data) {
         UpdateStates(data);
      },
      dataType: &quot;json&quot;});
   }, 2000);</pre></blockquote></div></div></div>

<div class="CGroup"><div class=CTopic><h3 class=CTitle><a name="Web_server_commands"></a>Web server commands</h3><div class=CBody><p>This section provides the list of the standard web server commands.</p></div></div></div>

<div class="CFunction"><div class=CTopic><h3 class=CTitle><a name="thc_Web.API.GetDeviceInfo"></a>thc_Web::<wbr>API::<wbr>GetDeviceInfo</h3><div class=CBody><p>Returns device information.&nbsp; GetDeviceInfo returns information about all available devices in the JSON format.&nbsp; The keys of the returned main list are the device identifiers.&nbsp; The values are sub lists composed by device attribute names and values.&nbsp; The following attributes are provided: &lsquo;name&rsquo;, &lsquo;type&rsquo;, &lsquo;group&rsquo;, &lsquo;format&rsquo;.</p><h4 class=CHeading>Parameters</h4><p>-</p><h4 class=CHeading>Returns</h4><p>Device information in JSON format</p><h4 class=CHeading>Examples (HTTP get request)</h4><blockquote><pre>http://localhost:8080/api/GetDeviceInfo
-&gt; {
   &quot;Light1stFloor_state&quot;:
     {&quot;name&quot;:&quot;Light1stFloor&quot;,&quot;type&quot;:&quot;switch&quot;,&quot;group&quot;:&quot;Light&quot;,&quot;format&quot;:&quot;%s&quot;},
   &quot;Temperature1stFloor_state&quot;:
     {&quot;name&quot;:&quot;Temperature1stFloor&quot;,&quot;type&quot;:&quot;level&quot;,&quot;group&quot;:&quot;Environment&quot;,&quot;format&quot;:&quot;%sC&quot;},
   &quot;Humidity1stFloor_state&quot;:
     {&quot;name&quot;:&quot;Humidity1stFloor&quot;,&quot;type&quot;:&quot;level&quot;,&quot;group&quot;:&quot;Environment&quot;,&quot;format&quot;:&quot;%s%%&quot;}
   }</pre></blockquote></div></div></div>

<div class="CFunction"><div class=CTopic><h3 class=CTitle><a name="thc_Web.API.GetDeviceStatesAfterEvent"></a>thc_Web::<wbr>API::<wbr>GetDeviceStatesAfterEvent</h3><div class=CBody><p>Waits on event and returns device states.&nbsp; GetDeviceStatesAfterEvent waits on a change of a device state (event) and returns then the new device states in the JSON format.&nbsp; This returned list contains pairs of device identifiers and device states.</p><h4 class=CHeading>Parameters</h4><p>-</p><h4 class=CHeading>Returns</h4><p>Device states in the JSON format</p><h4 class=CHeading>Examples (HTTP get request)</h4><blockquote><pre>http://localhost:8080/api/GetDeviceStatesAfterEvent
-&gt; {&quot;Light1stFloor_state&quot;: &quot;1&quot;, &quot;Temperature1stFloor_state&quot;: &quot;21.5C&quot;,
    &quot;Humidity1stFloor_state&quot;: &quot;68%&quot;}</pre></blockquote></div></div></div>

<div class="CFunction"><div class=CTopic><h3 class=CTitle><a name="thc_Web.API.GetDeviceStates"></a>thc_Web::<wbr>API::<wbr>GetDeviceStates</h3><div class=CBody><p>Returns device states.&nbsp; GetDeviceStatesAfterEvent returns then the current device states in the JSON format.&nbsp; This returned list contains pairs of device identifiers and device states.</p><h4 class=CHeading>Parameters</h4><p>-</p><h4 class=CHeading>Returns</h4><p>Device states in the JSON format</p><h4 class=CHeading>Examples (HTTP get request)</h4><blockquote><pre>http://localhost:8080/api/GetDeviceStates
-&gt; {&quot;Light1stFloor_state&quot;: &quot;1&quot;, &quot;Temperature1stFloor_state&quot;: &quot;21.5C&quot;,
    &quot;Humidity1stFloor_state&quot;: &quot;68%&quot;}</pre></blockquote></div></div></div>

<div class="CFunction"><div class=CTopic><h3 class=CTitle><a name="thc_Web.API.SetDeviceState"></a>thc_Web::<wbr>API::<wbr>SetDeviceState</h3><div class=CBody><p>Set device states.&nbsp; SetDeviceState sets the states of a list of devices accordantly to a specified level.</p><h4 class=CHeading>Parameters</h4><table border=0 cellspacing=0 cellpadding=0 class=CDescriptionList><tr><td class=CDLEntry>DeviceId</td><td class=CDLDescription>Device identifier</td></tr><tr><td class=CDLEntry>NewState</td><td class=CDLDescription>New state</td></tr></table><h4 class=CHeading>Returns</h4><p>Device states in the JSON format</p><h4 class=CHeading>Examples (HTTP and jQuery get requests)</h4><blockquote><pre>http://localhost:8080/api/SetDeviceState Light1stFloor_state 1
-&gt;
$.get(&quot;/api/SetDeviceState &quot;+DeviceId+&quot; 1&quot;);
-&gt;</pre></blockquote></div></div></div>

<div class="CFunction"><div class=CTopic><h3 class=CTitle><a name="thc_Web.API.GetDeviceData"></a>thc_Web::<wbr>API::<wbr>GetDeviceData</h3><div class=CBody><p>Get device data.&nbsp; GetDeviceData returns the data attached to a device, usually stored in an external file.</p><h4 class=CHeading>Parameters</h4><table border=0 cellspacing=0 cellpadding=0 class=CDescriptionList><tr><td class=CDLEntry>DeviceId</td><td class=CDLDescription>Device identifier</td></tr></table><h4 class=CHeading>Returns</h4><p>Binary device data</p><h4 class=CHeading>Examples (HTTP and jQuery get requests)</h4><blockquote><pre>http://localhost:8080/api/GetDeviceData Battery,1day
-&gt; &lt;&lt;&lt;Binary device data&gt;&gt;&gt;
$.get(&quot;/api/GetDeviceData &quot;+DeviceId);
-&gt; &lt;&lt;&lt;Binary device data&gt;&gt;&gt;</pre></blockquote></div></div></div>

<div class="CGroup"><div class=CTopic><h3 class=CTitle><a name="Web_server_command_set_extension"></a>Web server command set extension</h3><div class=CBody><p>The initial web server command set can be extended by defining additional commands inside the namespace <b>thc_Web::API</b>.&nbsp; Such command definitions can for example be made inside the THC configuration file.&nbsp; The web server commands need to return a list with 2 elements; The first one is the HTTP response MIME type, the second one is the HTTP response itself.</p><blockquote><pre>namespace eval thc_Web::API {
   proc GetDateTime {
      return [list text/plain \
                   [clock format $::Time -format {%A, %Y.%m.%d, %H:%M:%S}]]
   }
}</pre></blockquote><p>Instead of returning an explicit MIME type together with a raw data chunk an API command can also return a list composed by the keyword &lsquo;file&rsquo; and a file path.&nbsp; The web server will in this case return the MIME type related to the file extension together with the file content.</p><blockquote><pre>namespace eval thc_Web::API {
   proc GetLogo {
      return [list file &quot;/opt/mystuff/mylogo.gif&quot;]
   }
}</pre></blockquote><p>The web server is recognizes the following file extensions :</p><ul><li>.txt - text/plain</li><li>.htm - text/html .html text/html</li><li>.css - text/css</li><li>.gif - image/gif</li><li>.jpg - image/jpeg</li><li>.png - image/png</li><li>.xbm - image/x-xbitmap</li><li>.js  - application/javascript</li><li>.json - application/json</li><li>.xml - application/xml</li></ul><p>If a file extension is not recognized the MIME type &lsquo;text/plain&rsquo; is returned.&nbsp; Additional MIME types can be declared via the array variable thc_Web::HttpdMimeType.&nbsp; Example:</p><blockquote><pre>set thc_Web::HttpdMimeType(.mp4) &quot;audio/mp4&quot;</pre></blockquote></div></div></div>

</div><!--Content-->


<div id=Footer><a href="http://www.naturaldocs.org">Generated by Natural Docs</a></div><!--Footer-->


<div id=Menu><div class=MEntry><div class=MFile><a href="../../files/THC-Introduction-txt.html">THC - Introduction</a></div></div><div class=MEntry><div class=MFile><a href="../../files/THC-Getting-started-txt.html">THC - Getting started</a></div></div><div class=MEntry><div class=MFile><a href="../../files/THC-Basics-txt.html">THC - Basics</a></div></div><div class=MEntry><div class=MFile><a href="../../files2/thc-tcl.html">THC - Core functions</a></div></div><div class=MEntry><div class=MGroup><a href="javascript:ToggleMenu('MGroupContent1')">Target interface modules</a><div class=MGroupContent id=MGroupContent1><div class=MEntry><div class=MFile><a href="../thc_MeteoSwiss-tcl.html">MeteoSwiss</a></div></div><div class=MEntry><div class=MFile><a href="../thc_OpenWeatherMap-tcl.html">OpenWeatherMap</a></div></div><div class=MEntry><div class=MFile><a href="../thc_Virtual-tcl.html">Virtual devices</a></div></div><div class=MEntry><div class=MFile><a href="../thc_zWay/thc_zWay-tcl.html">z-Way/<wbr>Razberry interface</a></div></div></div></div></div><div class=MEntry><div class=MGroup><a href="javascript:ToggleMenu('MGroupContent2')">Extension modules</a><div class=MGroupContent id=MGroupContent2><div class=MEntry><div class=MFile><a href="../thc_Timer/thc_Timer-tcl.html">Job timer</a></div></div><div class=MEntry><div class=MFile><a href="../thc_HttpDServer-tcl.html">HTTP debug server</a></div></div><div class=MEntry><div class=MFile><a href="../thc_MailAlert-tcl.html">Mail alert</a></div></div><div class=MEntry><div class=MFile><a href="../thc_RandomLight-tcl.html">Random light control</a></div></div><div class=MEntry><div class=MFile><a href="../thc_Rrd/thc_Rrd-tcl.html">Status logging and graph generation</a></div></div><div class=MEntry><div class=MFile><a href="thc_Web-tcl.html">Web interface</a></div></div></div></div></div><div class=MEntry><div class=MGroup><a href="javascript:ToggleMenu('MGroupContent3')">Targets</a><div class=MGroupContent id=MGroupContent3><div class=MEntry><div class=MFile><a href="../../files4/Raspberry/Raspberry-installation-txt.html">THC installation on a Raspberry</a></div></div></div></div></div><div class=MEntry><div class=MGroup><a href="javascript:ToggleMenu('MGroupContent4')">Utilities</a><div class=MGroupContent id=MGroupContent4><div class=MEntry><div class=MFile><a href="../thc_Rrd/RrdManip-tcl.html">THC RRD database manipulation utility</a></div></div></div></div></div><div class=MEntry><div class=MGroup><a href="javascript:ToggleMenu('MGroupContent5')">Developers</a><div class=MGroupContent id=MGroupContent5><div class=MEntry><div class=MFile><a href="../../files/THC-Developers-txt.html">Developer information</a></div></div><div class=MEntry><div class=MFile id=MSelected>Web server API</div></div><div class=MEntry><div class=MFile><a href="../thc_zWay/thc_zWay-js.html">z-Way extension for THC</a></div></div></div></div></div><div class=MEntry><div class=MGroup><a href="javascript:ToggleMenu('MGroupContent6')">Index</a><div class=MGroupContent id=MGroupContent6><div class=MEntry><div class=MIndex><a href="../../index/General.html">Everything</a></div></div><div class=MEntry><div class=MIndex><a href="../../index/Functions.html">Functions</a></div></div></div></div></div><script type="text/javascript"><!--
var searchPanel = new SearchPanel("searchPanel", "HTML", "../../search");
--></script><div id=MSearchPanel class=MSearchPanelInactive><input type=text id=MSearchField value=Search onFocus="searchPanel.OnSearchFieldFocus(true)" onBlur="searchPanel.OnSearchFieldFocus(false)" onKeyUp="searchPanel.OnSearchFieldChange()"><select id=MSearchType onFocus="searchPanel.OnSearchTypeFocus(true)" onBlur="searchPanel.OnSearchTypeFocus(false)" onChange="searchPanel.OnSearchTypeChange()"><option  id=MSearchEverything selected value="General">Everything</option><option value="Functions">Functions</option></select></div></div><!--Menu-->



<!--START_ND_TOOLTIPS-->
<div class=CToolTip id="tt1"><div class=CGroup>This section provides the list of the standard web server commands.</div></div><div class=CToolTip id="tt2"><div class=CGroup>The initial web server command set can be extended by defining additional commands inside the namespace <b>thc_Web::API</b>. </div></div><!--END_ND_TOOLTIPS-->




<div id=MSearchResultsWindow><iframe src="" frameborder=0 name=MSearchResults id=MSearchResults></iframe><a href="javascript:searchPanel.CloseResultsWindow()" id=MSearchResultsWindowClose>Close</a></div>


<script language=JavaScript><!--
if (browserType) {if (browserVer) {document.write("</div>"); }document.write("</div>");}// --></script></body></html>